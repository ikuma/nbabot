# Polymarket NBA 自動取引システム -- 統合計画書

> 4つの専門家視点（PM、NBAリサーチ、エンジニア、リスク管理）の分析を統合

---

## 戦略転換の経緯

### 旧方針: テンポラルアービトラージ (廃止)

初期構想では、ブックメーカーオッズ (The Odds API) を「真の確率」の代理指標とし、Polymarket の価格調整遅延を検出するテンポラルアービトラージを主戦略としていた。

**廃止理由:**
- lhtsports の P&L 深掘り分析により、ブックメーカーとの差分 (数%) よりも Polymarket 自体の構造的ミスプライシング (20-36%) のほうが桁違いに大きいことが判明
- ブックメーカーオッズは「方向性」の補助情報にはなるが、エッジの主源泉ではない
- Odds API の月 500 リクエスト制限がスケーラビリティのボトルネックだった

旧方式のコードは `src/strategy/scanner.py` に `--mode bookmaker` として温存。完全削除はしない。

### 現行方針: キャリブレーション戦略

lhtsports の P&L 深掘り分析 ($38.7M リスク → +$1.2M, ROI 3.11%) により、**Polymarket の構造的ミスプライシングを校正テーブルで広く刈り取る戦略**に転換。

**根拠:**
1. **予測モデル不要**: 価格帯ベースで購入 — Polymarket 価格 0.20-0.55 のアウトカムを広く買う
2. **校正エッジが本体**: Polymarket は系統的にアウトカムを過小評価 (0.20-0.55 帯: 暗示確率 20-55% → 実勝率 71-95%)
3. **エッジは構造的・安定的**: 2024-Q4 → 2026-Q1 で校正エッジ +20-36% を維持。減衰していない
4. **ML+Total の独立エッジ**: ROI 2.3% → 10.0%。phi 相関 0.05 = ほぼ独立した追加エッジ源

**サイド選択**: 校正カーブが凹型 → EV/$ は低価格側ほど高い → 自然にアンダードッグ優先 (~85% 校正 EV 数学、~15% 外部方向性確信)。

### 校正テーブル (2024-12 〜 2026-02, 1,395 settled conditions)

| Band | N | 勝率 | ROI | 信頼度 | ゾーン |
|------|---|------|-----|--------|--------|
| 0.20-0.25 | 45 | 71.1% | 30.3% | medium | sweet spot |
| 0.25-0.30 | 54 | 85.2% | 54.5% | medium | sweet spot |
| 0.30-0.35 | 73 | 82.2% | 20.0% | medium | sweet spot |
| 0.35-0.40 | 104 | 90.4% | 26.1% | high | sweet spot |
| 0.40-0.45 | 121 | 91.7% | 7.4% | high | sweet spot |
| 0.45-0.50 | 162 | 93.8% | 5.9% | high | sweet spot |
| 0.50-0.55 | 169 | 94.7% | 6.2% | high | sweet spot |
| 0.55-0.60 | 141 | 95.7% | 4.0% | high | 0.5x Kelly |
| 0.60-0.65 | 78 | 97.4% | 16.0% | medium | 0.5x Kelly |
| 0.65-0.70 | 58 | 93.1% | 2.1% | medium | 0.5x Kelly |
| 0.70-0.75 | 45 | 93.3% | 15.5% | medium | 0.5x Kelly |
| 0.75-0.80 | 37 | 97.3% | 15.9% | low | 0.5x Kelly |
| 0.80-0.85 | 33 | 100% | 17.4% | low | 0.5x Kelly |
| 0.85-0.90 | 30 | 100% | 14.1% | low | 0.5x Kelly |
| 0.90-0.95 | 22 | 100% | 8.8% | low | 0.5x Kelly |

**注意**: 上記勝率は lhtsports の DCA (ドルコスト平均法) 込みの数値。シングルエントリーでは勝率は低下する (DCA 97% vs シングル 66%)。

### バックテスト結果 (直近1000試合: 2025-03 〜 2026-02)

- シグナル発生: **86.2%** (862/1000)
- 勝率: **93.7%** (808勝 54敗)
- モデル P&L: **+$555K** vs lhtsports 実績: **+$572K** (差 3%)
- Sweet Spot (0.20-0.55): 勝率 91.4%, P&L +$276K
- Outside (0.55-0.95): 勝率 96.8%, P&L +$278K

---

## フェーズ進捗

### Phase 1: 校正スキャナー + ペーパートレード — **完了**
- 校正テーブル (`src/strategy/calibration.py`) と校正スキャナー (`calibration_scanner.py`) を実装
- SQLite でシグナル・結果を記録 (`src/store/db.py`)
- Telegram 通知 (`src/notifications/telegram.py`)
- 日次スキャン (`scripts/scan.py`)
- 手動決済 (`scripts/settle.py` interactive mode)

### Phase 2: NBA.com 駆動ディスカバリー + 自動決済 — **完了**
- NBA.com スコアボード API でゲーム発見 (`src/connectors/nba_schedule.py`)
  - Odds API 依存を除去。calibration モードでは Odds API 不要に
  - スコア取得 (`home_score`, `away_score`) も対応
- チーム名逆引き (`full_name_from_abbr`) を `team_mapping.py` に追加
- **Auto-settle** (`scripts/settle.py --auto`):
  - NBA.com スコア (本日の final ゲーム) で自動勝敗判定 + PnL 記録
  - Polymarket Gamma Events API フォールバック (過去日付のシグナル)
  - `--dry-run` で確認のみモード
  - 決済結果を Telegram 通知
- cron 統合 (`scripts/cron_scan.sh`): scan → auto-settle を一気通貫実行

### Phase 2.5: 校正テーブル精緻化 + バックテスト — **完了**
- エッジ閾値 (`MIN_CALIBRATION_EDGE_PCT`) を撤廃 — EV > 0 のみでフィルタ
- 価格レンジフィルタ (`MIN_BUY_PRICE`, `MAX_BUY_PRICE`) を撤廃 — テーブル範囲のみ
- 校正テーブルを全データ (2024-12 〜 2026-02) で再構築
- 0.20-0.25 帯を追加（勝率 71.1%, ROI 30.3%）
- 直近1000試合バックテスト実施: 勝率 93.7%, モデル P&L +$555K
- DCA・MERGE の影響分析: WIN でも赤字になるメカニズムを解明

### Phase 3: DCA (ドルコスト平均法) 導入 — 未着手
lhtsports データで DCA の有効性が確認済み:
- **DCA 勝率 97.4%** vs シングル 66.0% (勝率 +31pt)
- **DCA 絶対 P&L +$468K** vs シングル +$10K (47倍)
- ただし **ROI は 4.8% vs 30.0%** に圧縮

段階的導入計画:
1. **Phase 3a**: DCA 上限 3-5回、price spread 上限 0.15、固定サイズ分割
2. **Phase 3b**: DCA 上限 5-10回に拡大、時間ベース DCA (試合前 2h/1h/30min)
3. **Phase 3c**: 価格変動データ収集、最適 DCA タイミング学習

注意点:
- Band 0.30-0.35 は WIN の 59% が赤字 (DCA の price spread が主因)
- DCA 5回が ROI/勝率の最適バランス (100% 勝率, 23.8% ROI)
- price spread > 0.30 で赤字リスク急増

### Phase 4: Total (O/U) マーケット対応 — 未着手
- Moneyline に加え、Total (Over/Under) マーケットの校正
- lhtsports 分析で ML+Total の独立エッジ (phi 相関 0.05) を確認済み
- ROI 2.3% → 10.0% への改善ポテンシャル

### Phase 5: スケール実行 + リスク管理 — 未着手
- 注文実行 (`src/execution/`)
- リスク管理 (`src/risk/`)
- 資金規模 $30-50K へのスケール
- bookmaker クロスバリデーション (高確信シグナルの追加フィルタ)

---

## リスク管理パラメータ (初期値)

| パラメータ | Phase 2 (現在) | Phase 3 (DCA) | Phase 5 (スケール) |
|-----------|---------------|--------------|-------------------|
| Kelly分数 | 0.25 | 0.25 | 0.25 |
| 1取引最大額 | $100 | $500 | $2,000 |
| DCA 上限回数 | 1 (シングル) | 3-5回 | 5-10回 |
| 日次損失上限 | 3% ($300) | 5% ($500) | 5% ($2,500) |
| 週次損失上限 | 5% ($500) | 8% ($800) | 8% ($4,000) |
| 最大ドローダウン | 15% | 20% | 20% |
| 最小エッジ | EV > 0 | EV > 0 | EV > 0 |
| 最大総エクスポージャー | 30% | 40% | 50% |
| 連敗縮小トリガー | 3連敗→50%縮小 | 5連敗→50%縮小 | 5連敗→50%縮小 |

### サーキットブレーカー
- **Level 1 (黄)**: 日次損失50%到達 or 3連敗 → サイズ50%縮小、15分クールダウン
- **Level 2 (橙)**: 日次損失上限到達 or 5連敗 → 全取引停止、人間の承認要
- **Level 3 (赤)**: 週次損失上限 or ドローダウン上限 → 全注文キャンセル、72時間停止

---

## 自動化完全移行の条件 (Phase 4 前提)

- [ ] ペーパートレード100取引以上完了
- [ ] 勝率 > 55%
- [ ] シャープレシオ > 1.5
- [ ] 最大ドローダウン < 10%
- [ ] 小額実弾テスト ($25-50) で50取引以上
- [ ] 3段階サーキットブレーカー実装済み
- [ ] Hot/Coldウォレット分離済み

---

## NBAデータ 日次ワークフロー (JST)

| 時刻 | アクション |
|------|----------|
| 06:00 | 前日結果の自動決済 (`settle.py --auto`) |
| 07:00 | 本日NBA市場スキャン (`scan.py`) |
| 07:30 | 校正テーブル照合、EV 計算 (calibration モード) |
| 08:00 | レポート生成、シグナル選定 |
| 08:30 | (オプション) bookmaker クロスバリデーション |
| 09:00 | 推奨アクション通知 (Telegram) |
| 09:00-12:30 | **試合前モニタリング** (ラインナップ確定、怪我確定を監視) |
| 12:30-16:00 | 試合中モニタリング |

cron 実行 (`scripts/cron_scan.sh`) で scan + auto-settle を一括実行。

---

## 技術スタック

- **言語**: Python 3.11+
- **Polymarket**: Gamma Events API (主) / `py-clob-client` (フォールバック)
- **ゲーム発見**: NBA.com Scoreboard API (Odds API は bookmaker モードのみ)
- **DB**: SQLite (`data/paper_trades.db`)
- **通知**: Telegram Bot API
- **CI**: pytest + ruff

---

## ウォレットセキュリティ
- **Cold Wallet (70%)**: ハードウェアウォレット、手動のみ
- **Hot Wallet (30%)**: BOT用、取引上限付き
- 秘密鍵は `.env` → 本番では AWS Secrets Manager
- Polygon上のUSDC、ガス代は$2-5のMATICで数千取引分

---

*本文書は戦略設計書であり、投資助言ではない。予測市場での取引には資金全額損失リスクがある。*
