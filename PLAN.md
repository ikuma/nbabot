# Polymarket NBA 自動取引システム -- 統合計画書

> 4つの専門家視点（PM、NBAリサーチ、エンジニア、リスク管理）の分析を統合

---

## 戦略転換 (2026-02)

### 旧方針: テンポラルアービトラージ
ブックメーカーオッズを真の確率の代理指標とし、Polymarket の価格調整遅延を検出。

### 新方針: キャリブレーション戦略

lhtsports の P&L 深掘り分析 ($38.7M リスク → +$1.2M, ROI 3.11%) により、**Polymarket の構造的ミスプライシングを校正テーブルで広く刈り取る戦略**に転換。

**根拠:**
1. **予測モデル不要**: 価格帯ベースで購入 — Polymarket 価格 0.25-0.55 のアウトカムを広く買う
2. **校正エッジが本体**: Polymarket は系統的にアウトカムを過小評価 (0.25-0.40 帯: 暗示確率 25-40% → 実勝率 72-80%)
3. **エッジは構造的・安定的**: 2024-Q4 → 2026-Q1 で校正エッジ +20-36% を維持。減衰していない
4. **ML+Total の独立エッジ**: ROI 2.3% → 10.0%。phi 相関 0.05 = ほぼ独立した追加エッジ源

**サイド選択**: 校正カーブが凹型 → EV/$ は低価格側ほど高い → 自然にアンダードッグ優先 (~85% 校正 EV 数学、~15% 外部方向性確信)。

**フェーズ:**
- Phase 1: 校正スキャナー追加 (既存 bookmaker モード温存) ← **完了**
- Phase 2: Polymarket 駆動ディスカバリー (Odds API 依存除去)
- Phase 3: Total (O/U) マーケット対応
- Phase 4: スケール実行 + リスク管理 ($30-50K)

旧 bookmaker 方式は `--mode bookmaker` で引き続き利用可能。Phase 4 で高確信シグナルの追加検証に活用予定。

---

## ~~全体コンセンサス~~ (旧方針 — 参考情報)

4専門家が一致した結論:

1. ~~**主戦略は「テンポラルアービトラージ」**~~ → **校正戦略に転換**
2. **NBAマネーライン（試合勝敗）市場から開始** -- 流動性が高く、日次決済で資本効率が最良
3. ~~**最大のエッジ源泉は「怪我情報の反映遅延」**~~ → **校正エッジ (価格帯ベース) が主エッジ源**
4. **LLMは「判断」に使い「実行」には使わない** -- ハルシネーションリスクを実行層に持ち込まない
5. **段階的に: レポート → アラート → 半自動 → 全自動**

---

## Phase 1: Daily Edge Finder (完了)

### やること
毎日、全NBA試合をスキャンし、校正テーブルに基づくミスプライシングを検出。レポートを自動生成する。**取引は人間が手動で実行。**

### アーキテクチャ
```
[cron: 毎日 15:00 JST]
     |
     v
[Claude Code 1セッション]
  入力: Polymarket API + OddsAPI + WebSearch(怪我情報)
  処理: 乖離計算 + LLM分析
  出力: reports/YYYY-MM-DD.md + Telegram通知(任意)
```

### 最小ディレクトリ構造
```
nbabot/
├── CLAUDE.md
├── PLAN.md
├── pyproject.toml
├── .env.example
├── .gitignore
├── src/
│   ├── __init__.py
│   ├── config.py              # Pydantic Settings
│   ├── connectors/
│   │   ├── polymarket.py      # py-clob-client wrapper
│   │   └── odds_api.py        # The Odds API
│   ├── strategy/
│   │   └── scanner.py         # 乖離検出
│   ├── risk/
│   │   └── manager.py         # Kelly基準 + ポジション上限
│   ├── execution/
│   │   └── executor.py        # 注文実行 (Phase 2~)
│   ├── notifications/
│   │   └── telegram.py        # 通知
│   └── store/
│       └── db.py              # SQLite (取引履歴)
├── scripts/
│   ├── check_balance.py       # API接続確認
│   ├── scan.py                # 日次スキャン
│   └── daily_report.py        # P&Lレポート
├── agents/
│   └── daily-edge-finder.md   # エージェントプロンプト
├── data/
│   └── reports/               # 日次レポート出力先
└── tests/
```

### 技術スタック
- **言語**: Python 3.11+
- **Polymarket**: `py-clob-client` v0.34.5 (公式Python client)
- **オッズ**: The Odds API (無料500req/月、有料$20~/月)
- **NBAデータ**: `nba_api` (無料、NBA.comラッパー)
- **LLM**: Claude API (分析) / Claude Code (レポート生成)
- **DB**: SQLite (MVP) → PostgreSQL (スケール時)
- **通知**: python-telegram-bot

### コスト見積もり
| 項目 | 月額 |
|------|------|
| Claude Code API | $90-150 |
| The Odds API | $0 (無料枠) ~ $20 |
| nba_api | $0 |
| **合計** | **$90-170/月** |

---

## Phase 2: リアルタイムアラート + 半自動実行 (2-4週間後)

- WebSocket接続でPolymarket価格をリアルタイム監視
- オッズ変動トリガーのTelegram即時通知
- Telegramの `/approve` コマンドでワンクリック注文実行
- `dry_run=True` → `dry_run=False` への段階的切替

---

## Phase 3: 完全自動化 (2-3ヶ月後)

### 移行条件 (全て必須)
- [ ] ペーパートレード100取引以上完了
- [ ] 勝率 > 55%
- [ ] シャープレシオ > 1.5
- [ ] 最大ドローダウン < 10%
- [ ] 小額実弾テスト ($25-50) で50取引以上
- [ ] 3段階サーキットブレーカー実装済み
- [ ] Hot/Coldウォレット分離済み

---

## リスク管理パラメータ (初期値)

| パラメータ | Phase 2 | Phase 3 |
|-----------|---------|---------|
| Kelly分数 | 0.25 | 0.25 |
| 1取引最大額 | $100 | $500 |
| 日次損失上限 | 3% ($300) | 5% ($500) |
| 週次損失上限 | 5% ($500) | 8% ($800) |
| 最大ドローダウン | 15% | 20% |
| 最小エッジ | 5% | 4% |
| 最大総エクスポージャー | 30% | 40% |
| 連敗縮小トリガー | 3連敗→50%縮小 | 5連敗→50%縮小 |

### サーキットブレーカー
- **Level 1 (黄)**: 日次損失50%到達 or 3連敗 → サイズ50%縮小、15分クールダウン
- **Level 2 (橙)**: 日次損失上限到達 or 5連敗 → 全取引停止、人間の承認要
- **Level 3 (赤)**: 週次損失上限 or ドローダウン上限 → 全注文キャンセル、72時間停止

### LLMハルシネーション対策
- 数値の妥当性チェック (確率が0-1の範囲内か)
- チーム名の実在確認
- エッジ計算の独立再検証
- 怪我情報の複数ソース照合 (RotoWire + NBA公式 + X)

---

## NBAデータ 日次ワークフロー (JST)

| 時刻 | アクション |
|------|----------|
| 06:00 | 前日結果確認、P&L計算 |
| 07:00 | 本日NBA市場スキャン (Polymarket API) |
| 07:30 | 校正テーブル照合、EV 計算 (calibration モード) |
| 08:00 | レポート生成、シグナル選定 |
| 08:30 | (オプション) bookmaker クロスバリデーション |
| 09:00 | 推奨アクション通知 (Telegram) |
| 09:00-12:30 | **試合前モニタリング** (ラインナップ確定、怪我確定を監視) |
| 12:30-16:00 | 試合中モニタリング |

---

## 次のアクション

1. **今すぐ**: `pyproject.toml` 作成、`scripts/check_balance.py` でPolymarket API接続確認
2. **今週**: `src/connectors/polymarket.py` + `src/strategy/scanner.py` 実装
3. **来週**: `src/notifications/telegram.py` + 日次スキャンのcron化
4. **2週間後**: 実データでのペーパートレード開始

---

## ウォレットセキュリティ
- **Cold Wallet (70%)**: ハードウェアウォレット、手動のみ
- **Hot Wallet (30%)**: BOT用、取引上限付き
- 秘密鍵は `.env` → 本番では AWS Secrets Manager
- Polygon上のUSDC、ガス代は$2-5のMATICで数千取引分

---

*本文書は戦略設計書であり、投資助言ではない。予測市場での取引には資金全額損失リスクがある。*
